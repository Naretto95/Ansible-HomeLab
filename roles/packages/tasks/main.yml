---

- name: Validate packages_state and repos_state
  assert:
    that:
      - packages_state is not defined or packages_state in ['present', 'absent']
      - repos_state is not defined or repos_state in ['present', 'absent']
    fail_msg: "packages_state and repos_state can only be 'present', 'absent', or undefined."

- name: Install Python with raw module
  raw: |
    apt-get update -y
    apt-get install -y python3 python3-apt
  when: os_family in ["Debian", "Proxmox"]
  changed_when: false

- name: Setup repositories
  include_tasks: repositories/setup_repositories.yml
  when: repos_state | default('present') == 'present'

- name: Install packages
  include_tasks: packages/install_packages.yml
  when: packages_state | default('present') == 'present'

- name: Remove packages
  include_tasks: packages/remove_packages.yml
  when: packages_state | default('present') == 'absent'